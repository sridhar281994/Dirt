name: Build Android App

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      USER: root
      HOME_DIR: /root    

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Prepare Build Environment
        run: |
          mkdir -p app_build
          # Copy frontend_app content to root of app_build
          cp -r frontend_app/* app_build/
          # Copy buildozer.spec
          cp buildozer.spec app_build/
          
          # Fix imports: remove 'frontend_app.' prefix
          # This assumes that frontend_app/* files are now at app_build/*
          find app_build -name "*.py" -print0 | xargs -0 sed -i 's/from frontend_app\./from /g'
          find app_build -name "*.py" -print0 | xargs -0 sed -i 's/import frontend_app\./import /g'
          
          # Also fix 'from frontend_app import' -> 'import' logic?
          # If we have 'from frontend_app.screens import X', it becomes 'from screens import X'.
          # If we have 'import frontend_app.utils', it becomes 'import utils'.
          
          # Adjust icon path in buildozer.spec if needed
          # In buildozer.spec: icon.filename = %(source.dir)s/frontend_app/assets/icon.png
          # In app_build, it will be at assets/icon.png
          sed -i 's|frontend_app/assets/icon.png|assets/icon.png|g' app_build/buildozer.spec
          
          # Verify structure
          ls -R app_build

      - name: Build with Buildozer
        uses: ArtemSBulgakov/buildozer-action@v1
        id: buildozer
        env:
          USER: root
          PIP_BREAK_SYSTEM_PACKAGES: "1"
        with:
          command: buildozer android debug
          buildozer_version: master
          workdir: app_build

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: app_build/bin/*.apk
