# Common background mixin logic or applied to each screen directly
# We will apply 'assets/background.png' to each screen's canvas.before.

<WelcomeScreen>:
    name: 'welcome'

    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: 'assets/background.png'

        BoxLayout:
            orientation: 'vertical'
            size_hint: None, None
            # Responsive width/height
            width: min(root.width * 0.9, dp(600))
            height: min(self.minimum_height, root.height * 0.85)
            spacing: dp(20)
            padding: dp(20)
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.6
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [20]

            Label:
                text: "Welcome to the Game!"
                font_size: min(root.width * 0.08, sp(28))
                color: 1, 1, 1, 1
                size_hint_y: None
                halign: "center"
                valign: "middle"
                text_size: self.width, None
                height: self.texture_size[1] + dp(20)

            Button:
                text: "Login"
                font_size: min(root.width * 0.05, sp(18))
                size_hint_y: None
                height: dp(50)
                background_color: (0.2, 0.5, 1, 1)
                on_release: root.manager.current = 'login'

            Button:
                text: "Register"
                font_size: min(root.width * 0.05, sp(18))
                size_hint_y: None
                height: dp(50)
                background_color: (0.3, 0.8, 0.3, 1)
                on_release: root.manager.current = 'register'

        Label:
            text: "¬© 2025 SRTech Games"
            font_size: min(root.width * 0.035, sp(14))
            color: 1, 1, 1, 0.7
            size_hint: None, None
            size: self.texture_size
            pos_hint: {"center_x": 0.5, "y": 0.05}

<LoginScreen>:
    name: "login"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: "assets/background.png"

        ScrollView:
            size_hint: 0.9, 0.9
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            do_scroll_x: False
            bar_width: 0

            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                # Centering in ScrollView
                pos_hint: {"center_x": 0.5} if root.width > dp(500) else {}
                spacing: dp(15)
                padding: dp(20)
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "Secure Login"
                    font_size: sp(24)
                    color: 1, 1, 1, 1
                    halign: "center"
                    valign: "middle"
                    text_size: self.width, None
                    size_hint_y: None
                    height: self.texture_size[1] + dp(10)

                # Account Details Box
                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)
                    padding: dp(10)
                    canvas.before:
                        Color:
                            rgba: 0.1, 0.15, 0.3, 0.8
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]

                    Label:
                        text: "Account Details"
                        font_size: sp(16)
                        color: 1, 1, 1, 0.9
                        size_hint_y: None
                        height: dp(30)

                    TextInput:
                        id: phone_input
                        hint_text: "Email / Username / Phone"
                        multiline: False
                        font_size: sp(16)
                        size_hint_y: None
                        height: dp(48)
                        background_color: (0.95, 0.95, 0.95, 1)
                        foreground_color: (0.1, 0.1, 0.1, 1)

                    RelativeLayout:
                        size_hint_y: None
                        height: dp(48)
                        TextInput:
                            id: password_input
                            hint_text: "Password"
                            password: login_password_toggle.state != "down"
                            multiline: False
                            font_size: sp(16)
                            size_hint: 1, 1
                            background_color: (0.95, 0.95, 0.95, 1)
                            foreground_color: (0.1, 0.1, 0.1, 1)
                            padding: [dp(10), dp(10), dp(40), dp(10)]
                        ToggleButton:
                            id: login_password_toggle
                            size_hint: None, None
                            size: dp(40), dp(40)
                            pos_hint: {"right": 1, "center_y": 0.5}
                            text: "üôà" if self.state == "down" else "üëÅ"
                            background_normal: ""
                            background_down: ""
                            background_color: (0,0,0,0)
                            color: (0.2, 0.2, 0.2, 1)

                    Button:
                        text: "Request OTP"
                        size_hint_y: None
                        height: dp(44)
                        background_color: (0.9, 0.6, 0.2, 1)
                        on_release: root.send_otp_to_user()

                # OTP Box
                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)
                    padding: dp(10)
                    canvas.before:
                        Color:
                            rgba: 0.2, 0.1, 0.25, 0.8
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]

                    Label:
                        text: "OTP Verification"
                        font_size: sp(16)
                        color: 1, 1, 1, 0.9
                        size_hint_y: None
                        height: dp(30)

                    TextInput:
                        id: otp_input
                        hint_text: "Enter OTP"
                        multiline: False
                        font_size: sp(16)
                        size_hint_y: None
                        height: dp(48)
                        background_color: (0.95, 0.95, 0.95, 1)
                        foreground_color: (0.1, 0.1, 0.1, 1)

                    Button:
                        text: "Verify & Login"
                        size_hint_y: None
                        height: dp(48)
                        background_color: (0.3, 0.8, 0.4, 1)
                        on_release: root.verify_and_login()

                    Button:
                        text: "Login as Guest"
                        size_hint_y: None
                        height: dp(44)
                        background_color: (0.3, 0.5, 0.9, 1)
                        on_release: root.login_as_guest()

                    Button:
                        text: "Forgot Password?"
                        size_hint_y: None
                        height: dp(40)
                        background_color: (0, 0, 0, 0)
                        on_release: root.open_forgot_password()

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<ForgotPasswordScreen>:
    name: "forgot_password"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: "assets/background.png"

        ScrollView:
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}

            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                spacing: dp(15)
                padding: dp(20)
                pos_hint: {"center_x": 0.5} if root.width > dp(500) else {}
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "Forgot Password"
                    font_size: sp(24)
                    size_hint_y: None
                    height: dp(40)

                TextInput:
                    id: phone_input
                    hint_text: "Registered Phone/Email"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)

                Button:
                    text: "Send OTP"
                    size_hint_y: None
                    height: dp(48)
                    on_release: root.send_reset_otp()

                TextInput:
                    id: otp_input
                    hint_text: "Enter OTP"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    disabled: not root.otp_stage_ready

                Button:
                    id: verify_btn
                    text: "Verify OTP"
                    size_hint_y: None
                    height: dp(48)
                    disabled: not root.otp_stage_ready
                    on_release: root.verify_otp_and_continue()

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<ResetPasswordScreen>:
    name: "reset_password"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: "assets/background.png"

        ScrollView:
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}

            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                spacing: dp(15)
                padding: dp(20)
                pos_hint: {"center_x": 0.5} if root.width > dp(500) else {}
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "Reset Password"
                    font_size: sp(24)
                    size_hint_y: None
                    height: dp(40)

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: password_input
                        hint_text: "New Password"
                        password: True
                        size_hint: 1, 1
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: "üëÅ"
                        background_color: (0,0,0,0)
                        on_state: password_input.password = (self.state == 'normal')

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: confirm_password_input
                        hint_text: "Confirm Password"
                        password: True
                        size_hint: 1, 1
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: "üëÅ"
                        background_color: (0,0,0,0)
                        on_state: confirm_password_input.password = (self.state == 'normal')

                Button:
                    text: "Save Password"
                    size_hint_y: None
                    height: dp(48)
                    background_color: (0.3, 0.8, 0.4, 1)
                    on_release: root.save_new_password()

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<RegisterScreen>:
    name: "register"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: "assets/background.png"

        ScrollView:
            size_hint: 0.94, 0.94
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            do_scroll_x: False

            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.92, dp(600))
                spacing: dp(12)
                padding: dp(20)
                pos_hint: {"center_x": 0.5} if root.width > dp(600) else {}
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "Create Account"
                    font_size: sp(26)
                    size_hint_y: None
                    height: dp(50)

                TextInput:
                    id: name_input
                    hint_text: "Full Name"
                    size_hint_y: None
                    height: dp(48)

                TextInput:
                    id: phone_input
                    hint_text: "Username"
                    size_hint_y: None
                    height: dp(48)

                TextInput:
                    id: email_input
                    hint_text: "Email"
                    size_hint_y: None
                    height: dp(48)

                Spinner:
                    id: country_spinner
                    text: "Select Country"
                    values: root.country_values()
                    size_hint_y: None
                    height: dp(48)

                Spinner:
                    id: gender_spinner
                    text: "male"
                    values: ["male", "female", "cross"]
                    size_hint_y: None
                    height: dp(48)

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: password_input
                        hint_text: "Password"
                        password: True
                        size_hint: 1, 1
                        padding: [dp(10), dp(10), dp(40), dp(10)]
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: "üëÅ"
                        background_color: (0,0,0,0)
                        on_state: password_input.password = (self.state == 'normal')

                Button:
                    text: "Register"
                    size_hint_y: None
                    height: dp(50)
                    background_color: (0.3, 0.7, 0.3, 1)
                    on_release: root.save_profile()

                Button:
                    text: "Login via Gmail"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.9, 0.6, 0.2, 1)
                    on_release: root.social_login("gmail")

                Button:
                    text: "Login via FB / Insta"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.2, 0.4, 0.9, 1)
                    on_release: root.social_login("fb/insta")

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<ChooseScreen>:
    name: "choose"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: "assets/background.png"

        # Top Bar
        BoxLayout:
            size_hint: 1, None
            height: dp(60)
            pos_hint: {"top": 1}
            padding: dp(10)
            spacing: dp(10)
            canvas.before:
                Color:
                    rgba: 0.1, 0.1, 0.1, 0.7
                Rectangle:
                    pos: self.pos
                    size: self.size

            Label:
                text: root.current_name or "Loading..."
                size_hint_x: 0.35
                text_size: self.size
                halign: "left"
                valign: "middle"
                shorten: True

            Label:
                text: root.current_country or ""
                size_hint_x: 0.25
                text_size: self.size
                halign: "left"
                valign: "middle"
                shorten: True

            Spinner:
                id: pref_spinner
                text: "both"
                values: ["male", "female", "both"]
                size_hint_x: 0.2

            Button:
                text: "Logout"
                size_hint_x: 0.2
                background_color: (0.8, 0.2, 0.2, 1)
                on_release: root.logout()

        # Main Card Area
        BoxLayout:
            orientation: "vertical"
            size_hint: 0.94, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.48}
            spacing: dp(10)

            # Profile View
            BoxLayout:
                orientation: "vertical"
                size_hint_y: 1
                padding: dp(10)
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [15]

                AsyncImage:
                    source: root.current_image_url if root.current_image_url else ""
                    size_hint_y: 0.6
                    allow_stretch: True
                    keep_ratio: True

                Label:
                    text: root.current_desc
                    size_hint_y: 0.2
                    text_size: self.size
                    halign: "center"
                    valign: "top"
                    padding: dp(10), dp(10)

                Label:
                    text: "Swipe Left/Right to browse"
                    size_hint_y: None
                    height: dp(20)
                    font_size: sp(12)
                    color: 0.8, 0.8, 0.8, 1

                # Chat Buttons
                BoxLayout:
                    size_hint_y: None
                    height: dp(48)
                    spacing: dp(10)
                    Button:
                        text: "Text Chat"
                        on_release: root.start_chat("text")
                    Button:
                        text: "Voice Chat"
                        on_release: root.start_chat("voice")

            # Public Chat & Subs
            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: dp(110)
                spacing: dp(5)

                Button:
                    text: "Public Chat (Free)"
                    size_hint_y: None
                    height: dp(40)
                    background_color: (0.8, 0.5, 0.2, 1)
                    on_release: root.start_public_chat()

                BoxLayout:
                    spacing: dp(5)
                    Button:
                        text: "Text: ‚Çπ50/hr"
                        font_size: sp(12)
                        on_release: root.subscribe("text_hour")
                    Button:
                        text: "Text: ‚Çπ10/10m"
                        font_size: sp(12)
                        on_release: root.subscribe("text_10min")

                BoxLayout:
                    spacing: dp(5)
                    Button:
                        text: "Voice: ‚Çπ200/hr"
                        font_size: sp(12)
                        on_release: root.subscribe("voice_hour")
                    Button:
                        text: "Voice: ‚Çπ30/10m"
                        font_size: sp(12)
                        on_release: root.subscribe("voice_10min")

<ChatScreen>:
    name: "chat"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: "assets/background.png"

        BoxLayout:
            orientation: "vertical"
            padding: dp(10)
            spacing: dp(10)

            # Header
            BoxLayout:
                size_hint_y: None
                height: dp(50)
                spacing: dp(10)
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.5
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Button:
                    text: "Back"
                    size_hint_x: None
                    width: dp(80)
                    on_release: root.go_back()
                Label:
                    text: "Chat (" + root.mode + ")"
                    bold: True

            # Messages
            ScrollView:
                do_scroll_x: False
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.3
                    Rectangle:
                        pos: self.pos
                        size: self.size
                GridLayout:
                    id: messages_box
                    cols: 1
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(8)
                    padding: dp(10)

            # Input
            BoxLayout:
                size_hint_y: None
                height: dp(50)
                spacing: dp(10)
                TextInput:
                    id: message_input
                    hint_text: "Type a message..."
                    multiline: False
                Button:
                    text: "Send"
                    size_hint_x: None
                    width: dp(80)
                    on_release: root.send_message()

<PublicChatScreen>:
    name: "public_chat"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: "assets/background.png"

        BoxLayout:
            orientation: "vertical"
            padding: dp(10)
            spacing: dp(10)

            BoxLayout:
                size_hint_y: None
                height: dp(50)
                spacing: dp(10)
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.5
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Button:
                    text: "Back"
                    size_hint_x: None
                    width: dp(80)
                    on_release: root.go_back()
                Label:
                    text: "Public Chat (Global)"
                    bold: True

            ScrollView:
                do_scroll_x: False
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.3
                    Rectangle:
                        pos: self.pos
                        size: self.size
                GridLayout:
                    id: messages_box
                    cols: 1
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(8)
                    padding: dp(10)

            BoxLayout:
                size_hint_y: None
                height: dp(50)
                spacing: dp(10)
                TextInput:
                    id: message_input
                    hint_text: "Type public message..."
                    multiline: False
                Button:
                    text: "Send"
                    size_hint_x: None
                    width: dp(80)
                    on_release: root.send_message()

<VideoScreen>:
    name: "video"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                source: "assets/background.png"

        BoxLayout:
            orientation: "vertical"
            padding: dp(20)
            spacing: dp(20)

            BoxLayout:
                size_hint_y: None
                height: dp(50)
                Button:
                    text: "Back"
                    size_hint_x: None
                    width: dp(100)
                    on_release: root.go_back()
                Label:
                    text: "Video Call"
                    bold: True

            Label:
                text: "Video Session Active\n\n(Mock Interface)\n\nID: " + str(root.session_id)
                halign: "center"
                font_size: sp(18)
