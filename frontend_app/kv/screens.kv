#:import CustomSpinner frontend_app.screens.Choose_screen.CustomSpinner
#:import AndroidSafeCamera frontend_app.widgets.safe_camera.AndroidSafeCamera

# Common background mixin logic or applied to each screen directly
# We will apply 'assets/background.png' to each screen's canvas.before.

<WideSpinnerOption@SpinnerOption>:
    font_size: sp(14)
    height: dp(44)
    size_hint_x: None
    # Wider so long options like "Change Password" aren't clipped.
    width: dp(320)
    text_size: self.width - dp(16), None
    halign: "left"
    valign: "middle"
    shorten: False

<SmallSpinnerOption@SpinnerOption>:
    font_size: sp(12)
    height: dp(40)

<WelcomeScreen>:
    name: 'welcome'

    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        BoxLayout:
            orientation: 'vertical'
            size_hint: None, None
            # Responsive width/height
            width: min(root.width * 0.9, dp(600))
            height: min(self.minimum_height, root.height * 0.85)
            spacing: dp(20)
            padding: dp(20)
            pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.6
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [20]

            Label:
                text: "Find Your Perfect Match"
                font_size: min(root.width * 0.08, sp(28))
                color: 1, 1, 1, 1
                size_hint_y: None
                halign: "center"
                valign: "middle"
                text_size: self.width, None
                height: self.texture_size[1] + dp(20)

            Button:
                text: "Login"
                font_size: min(root.width * 0.05, sp(18))
                size_hint_y: None
                height: dp(50)
                background_color: (0.2, 0.5, 1, 1)
                on_release: root.manager.current = 'login'

            Button:
                text: "Register"
                font_size: min(root.width * 0.05, sp(18))
                size_hint_y: None
                height: dp(50)
                background_color: (0.3, 0.8, 0.3, 1)
                on_release: root.manager.current = 'register'

        Label:
            text: "© 2025 SRTech Games"
            font_size: min(root.width * 0.035, sp(14))
            color: 1, 1, 1, 0.7
            size_hint: None, None
            size: self.texture_size
            pos_hint: {"center_x": 0.5, "y": 0.05}

<LoginScreen>:
    name: "login"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        ScrollView:
            size_hint: 0.9, 0.9
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            do_scroll_x: False
            bar_width: 0

            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                # Centering in ScrollView
                pos_hint: {"center_x": 0.5} if root.width > dp(500) else {}
                spacing: dp(15)
                padding: dp(20)
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "Secure Login"
                    font_size: sp(24)
                    color: 1, 1, 1, 1
                    halign: "center"
                    valign: "middle"
                    text_size: self.width, None
                    size_hint_y: None
                    height: self.texture_size[1] + dp(10)

                # Account Details Box
                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)
                    padding: dp(10)
                    canvas.before:
                        Color:
                            rgba: 0.1, 0.15, 0.3, 0.8
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]

                    Label:
                        text: "Account Details"
                        font_size: sp(16)
                        color: 1, 1, 1, 0.9
                        size_hint_y: None
                        height: dp(30)

                    TextInput:
                        id: phone_input
                        hint_text: "Email / Username / Phone"
                        multiline: False
                        font_size: sp(16)
                        size_hint_y: None
                        height: dp(48)
                        background_color: (0.95, 0.95, 0.95, 1)
                        foreground_color: (0.1, 0.1, 0.1, 1)

                    RelativeLayout:
                        size_hint_y: None
                        height: dp(48)
                        TextInput:
                            id: password_input
                            hint_text: "Password"
                            password: login_password_toggle.state != "down"
                            multiline: False
                            font_size: sp(16)
                            size_hint: 1, 1
                            background_color: (0.95, 0.95, 0.95, 1)
                            foreground_color: (0.1, 0.1, 0.1, 1)
                            padding: [dp(10), dp(10), dp(40), dp(10)]
                        ToggleButton:
                            id: login_password_toggle
                            size_hint: None, None
                            size: dp(40), dp(40)
                            pos_hint: {"right": 1, "center_y": 0.5}
                            text: ""
                            background_normal: ""
                            background_down: ""
                            background_color: (0,0,0,0)
                            color: (0.2, 0.2, 0.2, 1)
                            canvas:
                                Color:
                                    rgba: 0.2, 0.2, 0.2, 1
                                Line:
                                    width: 1.2
                                    ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                                Color:
                                    rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                                Ellipse:
                                    pos: self.x + dp(15), self.y + dp(15)
                                    size: dp(10), dp(10)
                                Color:
                                    rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                                Line:
                                    points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                    width: 1.2

                    BoxLayout:
                        size_hint_y: None
                        height: dp(32)
                        spacing: dp(10)
                        CheckBox:
                            id: remember_me
                            size_hint: None, None
                            size: dp(32), dp(32)
                            active: root.remember_me
                            on_active: root.remember_me = self.active
                        Label:
                            text: "Keep me logged in"
                            color: 1, 1, 1, 0.9
                            halign: "left"
                            valign: "middle"
                            text_size: self.size

                    Button:
                        text: "Request OTP"
                        size_hint_y: None
                        height: dp(44)
                        background_color: (0.9, 0.6, 0.2, 1)
                        on_release: root.send_otp_to_user()

                # OTP Box
                BoxLayout:
                    orientation: "vertical"
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(10)
                    padding: dp(10)
                    canvas.before:
                        Color:
                            rgba: 0.2, 0.1, 0.25, 0.8
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [10]

                    Label:
                        text: "OTP Verification"
                        font_size: sp(16)
                        color: 1, 1, 1, 0.9
                        size_hint_y: None
                        height: dp(30)

                    TextInput:
                        id: otp_input
                        hint_text: "Enter OTP"
                        multiline: False
                        font_size: sp(16)
                        size_hint_y: None
                        height: dp(48)
                        background_color: (0.95, 0.95, 0.95, 1)
                        foreground_color: (0.1, 0.1, 0.1, 1)

                    Button:
                        text: "Verify & Login"
                        size_hint_y: None
                        height: dp(48)
                        background_color: (0.3, 0.8, 0.4, 1)
                        on_release: root.verify_and_login()

                    Button:
                        text: "Login as Guest"
                        size_hint_y: None
                        height: dp(44)
                        background_color: (0.3, 0.5, 0.9, 1)
                        on_release: root.login_as_guest()

                    Button:
                        text: "Forgot Password?"
                        size_hint_y: None
                        height: dp(40)
                        background_color: (0, 0, 0, 0)
                        on_release: root.open_forgot_password()

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<ForgotPasswordScreen>:
    name: "forgot_password"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        ScrollView:
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}

            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                spacing: dp(15)
                padding: dp(20)
                pos_hint: {"center_x": 0.5} if root.width > dp(500) else {}
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: root.header_text
                    font_size: sp(24)
                    size_hint_y: None
                    height: dp(40)

                TextInput:
                    id: phone_input
                    hint_text: "Registered Phone/Email"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)

                Button:
                    text: "Send OTP"
                    size_hint_y: None
                    height: dp(48)
                    on_release: root.send_reset_otp()

                TextInput:
                    id: otp_input
                    hint_text: "Enter OTP"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    disabled: not root.otp_stage_ready

                Button:
                    id: verify_btn
                    text: "Verify OTP"
                    size_hint_y: None
                    height: dp(48)
                    disabled: not root.otp_stage_ready
                    on_release: root.verify_otp_and_continue()

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<ResetPasswordScreen>:
    name: "reset_password"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        ScrollView:
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}

            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                spacing: dp(15)
                padding: dp(20)
                pos_hint: {"center_x": 0.5} if root.width > dp(500) else {}
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "Reset Password"
                    font_size: sp(24)
                    size_hint_y: None
                    height: dp(40)

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: password_input
                        hint_text: "New Password"
                        password: True
                        size_hint: 1, 1
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: ""
                        background_color: (0,0,0,0)
                        on_state: password_input.password = (self.state == 'normal')
                        canvas:
                            Color:
                                rgba: 0.2, 0.2, 0.2, 1
                            Line:
                                width: 1.2
                                ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                            Ellipse:
                                pos: self.x + dp(15), self.y + dp(15)
                                size: dp(10), dp(10)
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                            Line:
                                points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                width: 1.2

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: confirm_password_input
                        hint_text: "Confirm Password"
                        password: True
                        size_hint: 1, 1
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: ""
                        background_color: (0,0,0,0)
                        on_state: confirm_password_input.password = (self.state == 'normal')
                        canvas:
                            Color:
                                rgba: 0.2, 0.2, 0.2, 1
                            Line:
                                width: 1.2
                                ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                            Ellipse:
                                pos: self.x + dp(15), self.y + dp(15)
                                size: dp(10), dp(10)
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                            Line:
                                points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                width: 1.2

                Button:
                    text: "Save Password"
                    size_hint_y: None
                    height: dp(48)
                    background_color: (0.3, 0.8, 0.4, 1)
                    on_release: root.save_new_password()

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<EditProfileScreen>:
    name: "edit_profile"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        ScrollView:
            size_hint: 0.9, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.5}

            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.9, dp(500))
                spacing: dp(15)
                padding: dp(20)
                pos_hint: {"center_x": 0.5} if root.width > dp(500) else {}
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "Edit Profile"
                    font_size: sp(24)
                    size_hint_y: None
                    height: dp(40)

                TextInput:
                    id: name_input
                    text: root.current_name
                    hint_text: "Full Name"
                    size_hint_y: None
                    height: dp(48)
                    font_size: sp(16)
                    multiline: False

                TextInput:
                    id: image_url_input
                    text: ""
                    hint_text: ""
                    size_hint_y: None
                    height: 0
                    opacity: 0
                    disabled: True

                Button:
                    text: "Save Changes"
                    size_hint_y: None
                    height: dp(48)
                    background_color: (0.3, 0.8, 0.4, 1)
                    on_release: root.save_profile()

                # Current profile photo preview + upload button
                BoxLayout:
                    size_hint_y: None
                    height: dp(90)
                    spacing: dp(10)

                    AsyncImage:
                        source: root.current_image_url if root.current_image_url else ""
                        size_hint: None, None
                        size: dp(80), dp(80)
                        fit_mode: "cover"

                    BoxLayout:
                        orientation: "vertical"
                        spacing: dp(6)
                        Label:
                            text: "Profile photo"
                            size_hint_y: None
                            height: dp(20)
                            color: 1, 1, 1, 0.9
                            halign: "left"
                            valign: "middle"
                            text_size: self.size

                        Button:
                            text: "Upload Image"
                            size_hint_y: None
                            height: dp(44)
                            background_color: (0.2, 0.5, 0.9, 1)
                            on_release: root.pick_image()

                Label:
                    text: "Options"
                    size_hint_y: None
                    height: dp(30)
                    color: 1, 1, 1, 0.7

                Button:
                    text: "Messages"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.2, 0.5, 0.8, 1)
                    on_release: root.go_history()

                Button:
                    text: "Change Password"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.2, 0.5, 0.8, 1)
                    on_release: root.change_password()

                Label:
                    text: "Subscribe"
                    size_hint_y: None
                    height: dp(30)
                    color: 1, 1, 1, 0.7
                
                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: dp(100)
                    spacing: dp(5)
                    Button:
                        text: "Text 1h"
                        on_release: root.subscribe("text_hour")
                    Button:
                        text: "Text 10m"
                        on_release: root.subscribe("text_10min")
                    Button:
                        text: "Video 1h"
                        on_release: root.subscribe("video_hour")
                    Button:
                        text: "Video 10m"
                        on_release: root.subscribe("video_10min")

                Button:
                    text: "Logout"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.8, 0.2, 0.2, 1)
                    on_release: root.logout()

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<RegisterScreen>:
    name: "register"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        ScrollView:
            size_hint: 0.94, 0.94
            pos_hint: {"center_x": 0.5, "center_y": 0.5}
            do_scroll_x: False

            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                width: min(root.width * 0.92, dp(600))
                spacing: dp(12)
                padding: dp(20)
                pos_hint: {"center_x": 0.5} if root.width > dp(600) else {}
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [20]

                Label:
                    text: "Create Account"
                    font_size: sp(26)
                    size_hint_y: None
                    height: dp(50)

                TextInput:
                    id: name_input
                    hint_text: "Full Name"
                    size_hint_y: None
                    height: dp(48)

                TextInput:
                    id: phone_input
                    hint_text: "Username"
                    size_hint_y: None
                    height: dp(48)

                TextInput:
                    id: email_input
                    hint_text: "Email"
                    size_hint_y: None
                    height: dp(48)

                Spinner:
                    id: country_spinner
                    text: "Select Country"
                    values: root.country_values()
                    size_hint_y: None
                    height: dp(48)

                Spinner:
                    id: gender_spinner
                    text: "male"
                    values: ["male", "female", "cross"]
                    size_hint_y: None
                    height: dp(48)

                RelativeLayout:
                    size_hint_y: None
                    height: dp(48)
                    TextInput:
                        id: password_input
                        hint_text: "Password"
                        password: True
                        size_hint: 1, 1
                        padding: [dp(10), dp(10), dp(40), dp(10)]
                    ToggleButton:
                        size_hint: None, None
                        size: dp(40), dp(40)
                        pos_hint: {'right': 1, 'center_y': 0.5}
                        text: ""
                        background_color: (0,0,0,0)
                        on_state: password_input.password = (self.state == 'normal')
                        canvas:
                            Color:
                                rgba: 0.2, 0.2, 0.2, 1
                            Line:
                                width: 1.2
                                ellipse: (self.x + dp(5), self.y + dp(10), dp(30), dp(20))
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'normal' else (0, 0, 0, 0)
                            Ellipse:
                                pos: self.x + dp(15), self.y + dp(15)
                                size: dp(10), dp(10)
                            Color:
                                rgba: (0.2, 0.2, 0.2, 1) if self.state == 'down' else (0, 0, 0, 0)
                            Line:
                                points: [self.x + dp(5), self.y + dp(10), self.x + dp(35), self.y + dp(30)]
                                width: 1.2

                Button:
                    text: "Register"
                    size_hint_y: None
                    height: dp(50)
                    background_color: (0.3, 0.7, 0.3, 1)
                    on_release: root.save_profile()

                Button:
                    text: "Login via Gmail"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.9, 0.6, 0.2, 1)
                    on_release: root.social_login("gmail")

                Button:
                    text: "Login via FB / Insta"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.2, 0.4, 0.9, 1)
                    on_release: root.social_login("fb/insta")

                Button:
                    text: "Back"
                    size_hint_y: None
                    height: dp(44)
                    background_color: (0.7, 0.2, 0.2, 1)
                    on_release: root.go_back()

<ChooseScreen>:
    name: "choose"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        # Top Bar
        BoxLayout:
            size_hint: 1, None
            height: dp(60)
            pos_hint: {"top": 1}
            padding: dp(5)
            spacing: dp(5)
            canvas.before:
                Color:
                    rgba: 0.1, 0.1, 0.1, 0.7
                Rectangle:
                    pos: self.pos
                    size: self.size

            AsyncImage:
                source: root.my_image_url
                size_hint: None, None
                size: dp(46), dp(46)
                fit_mode: "cover"

            Label:
                markup: True
                text: (root.my_name or "Loading...") + (("\n[size=12sp]" + root.my_desc + "[/size]") if root.my_desc else "")
                size_hint_x: 1
                text_size: self.size
                halign: "left"
                valign: "middle"
                shorten: True

            Label:
                text: root.my_country or ""
                size_hint_x: None
                width: dp(60)
                font_size: sp(11)
                text_size: self.size
                halign: "center"
                valign: "middle"
                shorten: True

            Spinner:
                id: pref_spinner
                text: "Both"
                values: ["Male", "Female", "Both"]
                size_hint_x: None
                width: dp(90)
                halign: "center"
                valign: "middle"
                on_text: root.set_preference(self.text)

            Button:
                text: "Profile"
                size_hint_x: None
                width: dp(70)
                background_color: (0.2, 0.2, 0.2, 1)
                on_release: root.manager.current = 'edit_profile'

        # Main Card Area
        BoxLayout:
            orientation: "vertical"
            size_hint: 0.94, 0.8
            pos_hint: {"center_x": 0.5, "center_y": 0.48}
            spacing: dp(10)

            # Profile View
            BoxLayout:
                orientation: "vertical"
                size_hint_y: 1
                padding: dp(10)
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.6
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [15]

                BoxLayout:
                    size_hint_y: None
                    height: dp(44)
                    spacing: dp(10)
                    padding: dp(6), dp(2)
                    Label:
                        text: (root.current_name or "") + (("  @" + root.current_username) if root.current_username else "")
                        bold: True
                        shorten: True
                        text_size: self.size
                        halign: "left"
                        valign: "middle"
                    Widget:
                        size_hint_x: None
                        width: dp(20)
                        size_hint_y: None
                        height: dp(20)
                        pos_hint: {'center_y': 0.5}
                        canvas:
                            Color:
                                rgba: (0.1, 0.9, 0.2, 1) if root.current_is_online else (0.9, 0.1, 0.1, 1)
                            Ellipse:
                                pos: self.x + dp(5), self.y + dp(5)
                                size: dp(10), dp(10)
                    Label:
                        text: root.current_country or ""
                        size_hint_x: None
                        width: dp(110)
                        shorten: True
                        text_size: self.size
                        halign: "right"
                        valign: "middle"

                Label:
                    text: root.current_desc or ""
                    size_hint_y: None
                    height: dp(24)
                    font_size: sp(12)
                    color: 0.9, 0.9, 0.9, 1
                    shorten: True
                    text_size: self.size
                    halign: "left"
                    valign: "middle"

                RelativeLayout:
                    size_hint_y: 0.6
                    AsyncImage:
                        id: choose_profile_image
                        source: root.current_image_url
                        fit_mode: "contain"
                        size_hint: 1, 1
                    # Replace big loading image with bold three dots.
                    Label:
                        markup: True
                        text: "[b]...[/b]"
                        font_size: sp(34)
                        color: 1, 1, 1, 0.85
                        pos_hint: {"center_x": 0.5, "center_y": 0.5}
                        opacity: 1 if (choose_profile_image.source and not choose_profile_image.texture) else 0

                BoxLayout:
                    size_hint_y: None
                    height: dp(60)
                    spacing: dp(20)
                    padding: dp(10)

                    Button:
                        # Use built-in Kivy atlas icon (no emoji fonts needed).
                        text: ""
                        font_size: sp(30)
                        size_hint_x: None
                        width: dp(60)
                        background_color: (0.8, 0.2, 0.2, 1)
                        on_release: root.swipe_left()
                        Image:
                            source: "atlas://data/images/defaulttheme/previous_normal"
                            size_hint: None, None
                            size: dp(26), dp(26)
                            center: self.parent.center

                    Widget:
                        size_hint_x: 1

                    Button:
                        # Use built-in Kivy atlas icon (no emoji fonts needed).
                        text: ""
                        font_size: sp(30)
                        size_hint_x: None
                        width: dp(60)
                        background_color: (0.2, 0.8, 0.2, 1)
                        on_release: root.swipe_right()
                        Image:
                            source: "atlas://data/images/defaulttheme/media-playback-start"
                            size_hint: None, None
                            size: dp(26), dp(26)
                            center: self.parent.center

                # Chat Buttons
                BoxLayout:
                    size_hint_y: None
                    height: dp(48)
                    spacing: dp(10)
                    Button:
                        text: "Text Date"
                        on_release: root.start_chat("text")
                    Button:
                        text: "Video Call"
                        on_release: root.start_video_chat()

            # Random Video Chat Button (moved inside main content)
            Button:
                text: "Start Video Date"
                size_hint_y: None
                height: dp(50)
                background_color: (0.8, 0.2, 0.8, 1)
                on_release: root.start_random_video_chat()

            # Public Chat & Subs
            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: dp(110)
                spacing: dp(5)

                Button:
                    text: "Public Chat (Free)"
                    size_hint_y: None
                    height: dp(40)
                    background_color: (0.8, 0.5, 0.2, 1)
                    on_release: root.start_public_chat()

                BoxLayout:
                    spacing: dp(5)
                    Button:
                        text: "Text: ₹50/hr"
                        font_size: sp(12)
                        on_release: root.subscribe("text_hour")
                    Button:
                        text: "Text: ₹10/10m"
                        font_size: sp(12)
                        on_release: root.subscribe("text_10min")

                BoxLayout:
                    spacing: dp(5)
                    Button:
                        text: "Video: ₹200/hr"
                        font_size: sp(12)
                        on_release: root.subscribe("video_hour")
                    Button:
                        text: "Video: ₹30/10m"
                        font_size: sp(12)
                        on_release: root.subscribe("video_10min")

<ChatScreen>:
    name: "chat"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        BoxLayout:
            orientation: "vertical"
            padding: dp(10)
            spacing: dp(10)

            # Header
            BoxLayout:
                size_hint_y: None
                height: dp(50)
                spacing: dp(10)
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.5
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Button:
                    text: "Back"
                    size_hint_x: None
                    width: dp(80)
                    on_release: root.go_back()
                Label:
                    text: "Chat (" + root.mode + ")"
                    bold: True
                Button:
                    text: "Report"
                    size_hint_x: None
                    width: dp(80)
                    background_color: (0.8, 0.2, 0.2, 1)
                    on_release: root.report_user()

            # Messages
            ScrollView:
                id: messages_scroll
                do_scroll_x: False
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.3
                    Rectangle:
                        pos: self.pos
                        size: self.size
                GridLayout:
                    id: messages_box
                    cols: 1
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(8)
                    padding: dp(10)

            # Input
            BoxLayout:
                size_hint_y: None
                height: dp(50)
                spacing: dp(10)
                TextInput:
                    id: message_input
                    hint_text: "Type a message..."
                    multiline: False
                Button:
                    text: "Send"
                    size_hint_x: None
                    width: dp(80)
                    on_release: root.send_message()

<PublicChatScreen>:
    name: "public_chat"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        BoxLayout:
            orientation: "vertical"
            padding: dp(10)
            spacing: dp(10)

            BoxLayout:
                size_hint_y: None
                height: dp(50)
                spacing: dp(10)
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.5
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Button:
                    text: "Back"
                    size_hint_x: None
                    width: dp(80)
                    on_release: root.go_back()
                Label:
                    text: "Public Chat (Global)"
                    bold: True
                Button:
                    text: "Report"
                    size_hint_x: None
                    width: dp(80)
                    background_color: (0.8, 0.2, 0.2, 1)
                    on_release: root.report_chat()

            ScrollView:
                id: messages_scroll
                do_scroll_x: False
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.3
                    Rectangle:
                        pos: self.pos
                        size: self.size
                GridLayout:
                    id: messages_box
                    cols: 1
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(8)
                    padding: dp(10)

            BoxLayout:
                size_hint_y: None
                height: dp(50)
                spacing: dp(10)
                TextInput:
                    id: message_input
                    hint_text: "Type public message..."
                    multiline: False
                Button:
                    text: "Send"
                    size_hint_x: None
                    width: dp(80)
                    on_release: root.send_message()

<VideoScreen>:
    name: "video"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        # Remote Video Area (Full Screen)
        RelativeLayout:
            size_hint: 1, 1
            pos_hint: {"x": 0, "y": 0}
            
            # Dark background for video area
            # canvas.before:
            #     Color:
            #         rgba: 0.1, 0.1, 0.15, 1
            #     Rectangle:
            #         pos: self.pos
            #         size: self.size

            # Remote video area:
            # - keep it BLACK until connected
            # - show remote image as a lightweight placeholder once a match exists
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 1
                Rectangle:
                    pos: self.pos
                    size: self.size

            AsyncImage:
                id: remote_video
                source: root.match_image_url if root.session_id > 0 and root.match_username else ""
                fit_mode: "contain"
                size_hint: 1, 1
                pos_hint: {"center_x": 0.5, "center_y": 0.5}

            # Loading "GIF" (animated spinner) shown until connected to an online match.
            Scatter:
                id: loading_spinner
                size_hint: None, None
                size: dp(70), dp(70)
                pos_hint: {"center_x": 0.5, "center_y": 0.55}
                do_translation: False
                do_scale: False
                do_rotation: False
                rotation: 0
                opacity: 1 if root.show_loading else 0
                disabled: not root.show_loading
                Image:
                    source: "atlas://data/images/defaulttheme/spinner"
                    size_hint: None, None
                    size: self.parent.size
                    pos: 0, 0

            # "Connecting..." overlay when no match
            Label:
                text: (root.match_desc or "Searching for match...") if not root.match_username else ""
                font_size: sp(18)
                color: 1, 1, 1, 0.8
                pos_hint: {"center_x": 0.5, "center_y": 0.5}

            Label:
                text: "Connecting..." if root.session_id > 0 and not root.match_username else ""
                font_size: sp(16)
                color: 1, 1, 1, 0.7
                pos_hint: {"center_x": 0.5, "center_y": 0.45}

        # Top Bar (always available)
        BoxLayout:
            id: top_bar
            size_hint: 1, None
            height: dp(50)
            pos_hint: {"top": 1}
            padding: dp(8)
            spacing: dp(10)
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.55
                Rectangle:
                    pos: self.pos
                    size: self.size

            Button:
                text: "Back"
                size_hint_x: None
                width: dp(80)
                background_color: (0.2, 0.2, 0.2, 1)
                on_release: root.go_back()

            Label:
                text: "Video Call"
                bold: True
                color: 1, 1, 1, 1
                shorten: True
                text_size: self.size
                halign: "left"
                valign: "middle"

            Label:
                text: "● LIVE" if root.session_id > 0 else "● CONNECTING"
                size_hint_x: None
                width: dp(130)
                font_size: sp(12)
                color: (0.2, 1, 0.3, 1) if root.session_id > 0 else (1, 0.8, 0.2, 1)
                bold: True
                text_size: self.size
                halign: "right"
                valign: "middle"

        # Chat Messages Overlay (Transparent Background)
        ScrollView:
            id: chat_overlay
            size_hint: 0.6, 0.3
            pos_hint: {"x": 0.02, "y": 0.2}
            opacity: 1 if root.controls_visible else 0
            disabled: not root.controls_visible
            do_scroll_x: False
            bar_width: dp(6)
            
            GridLayout:
                id: chat_box
                cols: 1
                size_hint_y: None
                height: self.minimum_height
                padding: dp(5)
                spacing: dp(5)
                # Transparent background for readability
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.3
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [10]

        # Controls Overlay (Bottom)
        BoxLayout:
            id: controls_overlay
            orientation: "vertical"
            size_hint_y: None
            height: dp(110)
            pos_hint: {"x": 0, "y": 0}
            padding: dp(10)
            spacing: dp(5)
            opacity: 1 if root.controls_visible else 0
            disabled: not root.controls_visible
            
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.6
                Rectangle:
                    pos: self.pos
                    size: self.size

            # Chat Input
            BoxLayout:
                size_hint_y: None
                height: dp(40)
                spacing: dp(10)
                
                TextInput:
                    id: chat_input
                    hint_text: "Type a message..."
                    multiline: False
                    size_hint_x: 0.8
                    background_color: 1, 1, 1, 0.2
                    foreground_color: 1, 1, 1, 1
                    cursor_color: 1, 1, 1, 1
                
                Button:
                    text: "Send"
                    size_hint_x: 0.2
                    background_color: 0.2, 0.6, 0.9, 1
                    on_release: root.send_message()

            # Action Buttons & Info
            BoxLayout:
                size_hint_y: None
                height: dp(40)
                spacing: dp(10)

                Label:
                    text: str(int(root.remaining_seconds)) + "s"
                    size_hint_x: None
                    width: dp(40)
                    bold: True
                    color: 1, 0.2, 0.2, 1

                Label:
                    text: (root.match_name or "...") 
                    size_hint_x: 0.3
                    shorten: True
                
                Button:
                    text: "End"
                    background_color: 0.8, 0.2, 0.2, 1
                    on_release: root.end_call()

                # Mic mute toggle (mic / mic with strike).
                # Uses canvas drawing so it works on Android without emoji fonts.
                Button:
                    size_hint_x: None
                    width: dp(46)
                    text: ""
                    background_normal: ""
                    background_down: ""
                    background_color: 0, 0, 0, 0
                    on_release: root.toggle_mute()
                    canvas.before:
                        Color:
                            rgba: (0.2, 0.2, 0.2, 0.9) if root.is_muted else (0.25, 0.25, 0.25, 0.8)
                        RoundedRectangle:
                            pos: self.pos
                            size: self.size
                            radius: [dp(10)]
                    canvas.after:
                        # Mic body (simple)
                        Color:
                            rgba: 1, 1, 1, 1
                        Line:
                            width: 1.4
                            ellipse: (self.center_x - dp(7), self.center_y - dp(2), dp(14), dp(16))
                        Line:
                            width: 1.4
                            points: [self.center_x, self.center_y - dp(2), self.center_x, self.center_y - dp(12)]
                        Line:
                            width: 1.4
                            points: [self.center_x - dp(6), self.center_y - dp(12), self.center_x + dp(6), self.center_y - dp(12)]
                        # Strike when muted
                        Color:
                            rgba: (1, 0.25, 0.25, 1) if root.is_muted else (0, 0, 0, 0)
                        Line:
                            width: 2.0
                            points: [self.x + dp(12), self.y + dp(12), self.right - dp(12), self.top - dp(12)]

                # Camera flip button (renamed as requested)
                Button:
                    text: "Front-cam" if root.is_front_camera else "Back-cam"
                    font_size: sp(11)
                    size_hint_x: None
                    width: dp(80)
                    background_color: (0.4, 0.4, 0.4, 1)
                    on_release: root.toggle_camera()
                
                Button:
                    text: "Next"
                    background_color: 0.2, 0.8, 0.2, 1
                    on_release: root.next_call()

                Button:
                    text: "Report"
                    background_color: 0.5, 0.1, 0.1, 1
                    on_release: root.report_user()

        # Local camera preview (Bottom Right, Smaller)
        BoxLayout:
            id: local_preview
            size_hint: None, None
            # Make local preview easier to see.
            size: dp(120), dp(160)
            # Keep it at bottom-right, just above the controls overlay.
            pos: root.width - self.width - dp(10), controls_overlay.height + dp(10)
            opacity: 1
            
            canvas.before:
                Color:
                    rgba: 0, 0, 0, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            # Rotate preview on Android to match portrait UI.
            Scatter:
                id: local_preview_scatter
                size_hint: None, None
                size: self.parent.size
                pos: 0, 0
                do_translation: False
                do_scale: False
                do_rotation: False
                rotation: root.local_preview_rotation
                center: self.parent.center
                canvas.before:
                    PushMatrix
                    Scale:
                        x: root.local_preview_scale_x
                        y: 1
                        origin: self.center
                canvas.after:
                    PopMatrix

                AndroidSafeCamera:
                    id: local_camera
                    # Keep local preview visible while searching/after ending.
                    play: root.camera_permission_granted and root.camera_should_play
                    fit_mode: "cover"
                    size_hint: None, None
                    size: local_preview_scatter.size
                    pos: 0, 0

<StartVideoDateScreen>:
    name: "start_video_date"

    FloatLayout:
        canvas.before:
            Color:
                rgba: 0, 0, 0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        ####################################################################
        # LOCAL CAMERA PREVIEW (BOTTOM-RIGHT, STRAIGHT)
        ####################################################################
        BoxLayout:
            id: self_pip
            size_hint: None, None
            size: dp(150), dp(200)
            pos: root.width - self.width - dp(12), dp(12)

            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.9
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [dp(14)]

            Scatter:
                size_hint: 1, 1
                pos: 0, 0
                do_translation: False
                do_scale: False
                do_rotation: False
                rotation: 0
                center: self.parent.center

                canvas.before:
                    PushMatrix
                    Scale:
                        x: -1 if root.is_front_camera else 1
                        y: 1
                        origin: self.center
                canvas.after:
                    PopMatrix

                AndroidSafeCamera:
                    id: local_camera
                    play: root.camera_permission_granted and root.camera_should_play
                    fit_mode: "cover"
                    allow_stretch: True
                    keep_ratio: False
                    size_hint: 1, 1

        ####################################################################
        # LOADING SPINNER
        ####################################################################
        Scatter:
            size_hint: None, None
            size: dp(70), dp(70)
            pos_hint: {"center_x": 0.5, "center_y": 0.55}
            do_translation: False
            do_scale: False
            do_rotation: False
            opacity: 1 if root.show_loading else 0
            disabled: not root.show_loading

            Image:
                source: "atlas://data/images/defaulttheme/spinner"
                size: self.size

        Label:
            text: root.status_text
            font_size: sp(18)
            color: 1, 1, 1, 0.85
            pos_hint: {"center_x": 0.5, "center_y": 0.45}

        ####################################################################
        # CHAT OVERLAY
        ####################################################################
        ScrollView:
            size_hint: 0.62, 0.22
            pos_hint: {"x": 0.02, "y": 0.18}
            do_scroll_x: False

            GridLayout:
                id: chat_box
                cols: 1
                size_hint_y: None
                height: self.minimum_height
                padding: dp(6)
                spacing: dp(4)

                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.25
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [dp(10)]

        ####################################################################
        # CHAT INPUT
        ####################################################################
        BoxLayout:
            size_hint: 0.62, None
            height: dp(38)
            pos_hint: {"x": 0.02, "y": 0.11}
            spacing: dp(6)
            padding: dp(6), dp(4)

            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.25
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [dp(10)]

            TextInput:
                id: chat_input
                hint_text: "Message..."
                multiline: False
                background_color: 1, 1, 1, 0.12
                foreground_color: 1, 1, 1, 1
                cursor_color: 1, 1, 1, 1

            Button:
                text: "Send"
                size_hint_x: None
                width: dp(70)
                on_release: root.send_message()

        ####################################################################
        # TOP BAR
        ####################################################################
        BoxLayout:
            size_hint: 1, None
            height: dp(50)
            pos_hint: {"top": 1}
            padding: dp(8)
            spacing: dp(10)

            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.55
                Rectangle:
                    pos: self.pos
                    size: self.size

            Button:
                text: "Back"
                size_hint_x: None
                width: dp(80)
                on_release: root.go_back()

            Label:
                text: "Start Video Date"
                bold: True
                color: 1, 1, 1, 1
                halign: "left"
                valign: "middle"
                text_size: self.size

            Label:
                text: "● CONNECTING" if root.show_loading else "● READY"
                size_hint_x: None
                width: dp(130)
                font_size: sp(12)
                color: (1, 0.8, 0.2, 1) if root.show_loading else (0.2, 1, 0.3, 1)
                bold: True
                halign: "right"
                valign: "middle"
                text_size: self.size

        ####################################################################
        # BOTTOM CONTROLS
        ####################################################################
        BoxLayout:
            id: bottom_controls
            size_hint: 1, None
            height: dp(104)
            pos_hint: {"y": 0}
            padding: dp(10)
            spacing: dp(8)
            orientation: "vertical"

            canvas.before:
                Color:
                    rgba: 0, 0, 0, 0.6
                Rectangle:
                    pos: self.pos
                    size: self.size

            BoxLayout:
                size_hint_y: None
                height: dp(40)
                spacing: dp(10)

                Button:
                    text: "Retry"
                    size_hint_x: 0.33
                    on_release: root.retry()

                Button:
                    text: "Next"
                    size_hint_x: 0.33
                    on_release: root.next_call()

                Button:
                    text: "End"
                    background_color: 0.8, 0.2, 0.2, 1
                    opacity: 1 if root.session_id > 0 else 0
                    disabled: root.session_id <= 0
                    size_hint_x: 0.34 if root.session_id > 0 else 0.0001
                    on_release: root.end_call()

            BoxLayout:
                size_hint_y: None
                height: dp(40)
                spacing: dp(10)

                Button:
                    text: "Front-cam" if root.is_front_camera else "Back-cam"
                    size_hint_x: 0.6
                    on_release: root.toggle_camera()

                Button:
                    text: "Cancel"
                    size_hint_x: 0.4
                    on_release: root.go_back()

<UserMatchScreen>:
    name: "user_match"
    FloatLayout:
        canvas.before:
            Color:
                rgba: 0.9, 0.45, 0.0, 1
            Rectangle:
                pos: self.pos
                size: self.size

        BoxLayout:
            orientation: "vertical"
            padding: dp(10)
            spacing: dp(10)

            # Header
            BoxLayout:
                size_hint_y: None
                height: dp(50)
                spacing: dp(10)
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.5
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Button:
                    text: "Back"
                    size_hint_x: None
                    width: dp(80)
                    on_release: root.go_back()
                Label:
                text: "Messages"
                    bold: True
                    font_size: sp(18)

            # Messages List
            ScrollView:
                do_scroll_x: False
                canvas.before:
                    Color:
                        rgba: 0, 0, 0, 0.3
                    Rectangle:
                        pos: self.pos
                        size: self.size
                GridLayout:
                    id: history_box
                    cols: 1
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(8)
                    padding: dp(10)
